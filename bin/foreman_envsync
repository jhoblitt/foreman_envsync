#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require "optparse"
require "rest-client"
require "socket"
require "yaml"

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: foreman_envsync [options]"
  opts.separator ""
  opts.separator "Specifc options:"

  opts.on("-v", "--verbose", "Enable verbose output") do |o|
    options[:verbose] = [o]
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end
option_parser.parse!

hostname = Socket.gethostname

def cert_file(file)
  OpenSSL::X509::Certificate.new(File.read(file))
end

def key_file(file)
  OpenSSL::PKey::RSA.new(File.read(file))
end

#
# Fetch list of puppet environments from puppetserver API.
#
res = RestClient::Request.execute(
  method: :get,
  url: "https://#{hostname}:8140/puppet/v3/environments",
  ssl_client_cert: cert_file("/etc/puppetlabs/puppet/ssl/certs/#{hostname}.pem"),
  ssl_client_key: key_file("/etc/puppetlabs/puppet/ssl/private_keys/#{hostname}.pem"),
  verify_ssl: true,
  ssl_ca_file: "/etc/puppetlabs/puppet/ssl/ca/ca_crt.pem"
)

ps_envs = JSON.parse(res)["environments"].keys

if options[:verbose]
  puts "found #{ps_envs.count} puppetserver environment(s)."
  puts YAML.dump(ps_envs)
end
