#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require "open3"
require "optparse"
require "rest-client"
require "socket"
require "yaml"

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: foreman_envsync [options]"
  opts.separator ""
  opts.separator "Specifc options:"

  opts.on("-v", "--verbose", "Enable verbose output") do |o|
    options[:verbose] = [o]
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end
option_parser.parse!

hostname = Socket.gethostname

def cert_file(file)
  OpenSSL::X509::Certificate.new(File.read(file))
end

def key_file(file)
  OpenSSL::PKey::RSA.new(File.read(file))
end

def parse_foreman_cmd(cmd, field)
  stdout, stderr, s = Open3.capture3(cmd)
  unless s.success?
    puts "command #{cmd} failed"
    puts stderr
    exit s.exitstatus
  end

  # hammer output format is an array of hashes -- one hash per item
  # convert it to a flat array
  JSON.parse(stdout).collect { |x| x[field] }
end

def foreman_env_list
  field = "Name"
  cmd = "hammer --output=json puppet-environment list --fields #{field}"

  parse_foreman_cmd(cmd, field)
end

#
# Fetch list of puppet environments from puppetserver API.
#
res = RestClient::Request.execute(
  method: :get,
  url: "https://#{hostname}:8140/puppet/v3/environments",
  ssl_client_cert: cert_file("/etc/puppetlabs/puppet/ssl/certs/#{hostname}.pem"),
  ssl_client_key: key_file("/etc/puppetlabs/puppet/ssl/private_keys/#{hostname}.pem"),
  verify_ssl: true,
  ssl_ca_file: "/etc/puppetlabs/puppet/ssl/ca/ca_crt.pem"
)

ps_envs = JSON.parse(res)["environments"].keys

if options[:verbose]
  puts "found #{ps_envs.count} puppetserver environment(s)."
  puts YAML.dump(ps_envs) if ps_envs.count
end

#
# Fetch list of puppet environments from foreman. The hammer cli is used to
# avoid having to manage credentials.  In theory, foreman supports auth using
# x509 similar to puppetserver but this failed when tested using both `curl` and
# configuring hammer to use x509.
#
f_envs = foreman_env_list

if options[:verbose]
  puts "found #{f_envs.count} foreman environment(s)."
  puts YAML.dump(f_envs) if f_envs.count
end

#
# Does foreman have any puppet envs puppetserver is unaware of?
#
extra_envs = f_envs - ps_envs

if options[:verbose]
  puts "found #{extra_envs.count} foreman environment(s) unknown to puppetserver."
  puts YAML.dump(extra_envs) if f_envs.count
end
